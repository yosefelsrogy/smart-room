<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Smart Home - Live Status</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #0f172a; color: white; text-align: center; padding: 20px; }
        h2 { color: #38bdf8; }
        .card { background: #1e293b; padding: 20px; margin: 15px auto; border-radius: 20px; max-width: 350px; box-shadow: 0 10px 15px rgba(0,0,0,0.3); border: 1px solid #334155; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-left: 10px; }
        .on-status { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .off-status { background: #ef4444; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .on-btn { background: #22c55e; color: white; }
        .off-btn { background: #ef4444; color: white; }
        button:active { transform: scale(0.9); }
        .status-text { margin-top: 10px; font-weight: bold; font-size: 0.9rem; }
    </style>
</head>
<body>

    <h2>ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</h2>
    <div id="devices-container"></div>

<script>
    // Ù…ÙØªØ§Ø­ Ø§Ù„Ù€ API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
    const API_KEY = "1c208e5d-af4d-4354-9e21-f75242e3fde8"; 

    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
    const devices = [
        { id: '697988922c0599192ae83298', name: 'Ø§Ù„Ù„Ù…Ø¨Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰' },
        { id: '697989702c0599192ae83307', name: 'Ø§Ù„Ù„Ù…Ø¨Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©' },
        { id: '697989de40cb098d90c7aad7', name: 'Ø§Ù„Ù„Ù…Ø¨Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©' }
    ];

    // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£ÙˆØ§Ù…Ø±
    async function sendAction(deviceId, value) {
        const stateValue = value.toLowerCase(); 
        
        // Ø¬Ø±Ø¨Ù†Ø§ Ø§Ù„ØµÙŠØºØªÙŠÙ† Ø§Ù„Ù„ØªÙŠÙ† ÙŠÙ‚Ø¨Ù„Ù‡Ù…Ø§ Ø§Ù„Ø³ÙŠØ±ÙØ± (state Ùˆ powerState)
        const payloads = [
            { "action": "setPowerState", "value": { "state": stateValue } },
            { "action": "setPowerState", "value": { "powerState": stateValue } }
        ];

        let success = false;

        for (let payload of payloads) {
            try {
                const response = await fetch(`https://api.sinric.pro/api/v1/devices/${deviceId}/action`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-sinric-api-key': API_KEY 
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    success = true;
                    updateUI(deviceId, stateValue);
                    console.log("Ù†Ø¬Ø­ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…:", payload);
                    break; 
                }
            } catch (err) {
                console.error("Connection Error:", err);
            }
        }

        if (!success) {
            alert("ÙØ´Ù„ Ø§Ù„ØªØ­ÙƒÙ…. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø¥Ø¶Ø§ÙØ© CORS ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.");
        }
    }

    // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    async function getStatus(deviceId) {
        try {
            const response = await fetch(`https://api.sinric.pro/api/v1/devices/${deviceId}`, {
                headers: { 'x-sinric-api-key': API_KEY }
            });
            const data = await response.json();
            if (data.payload && data.payload.state) {
                const state = data.payload.state.powerState || data.payload.state.state || "off";
                updateUI(deviceId, state.toString());
            }
        } catch (err) {
            console.error("Status Error:", err);
        }
    }

    // Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
    function renderDevices() {
        const container = document.getElementById('devices-container');
        container.innerHTML = devices.map(dev => `
            <div class="card">
                <h3>${dev.name} <span id="ind-${dev.id}" class="status-indicator off-status"></span></h3>
                <div class="status-text" id="status-${dev.id}">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</div>
                <div class="btn-group">
                    <button class="on-btn" onclick="sendAction('${dev.id}', 'on')">ØªØ´ØºÙŠÙ„</button>
                    <button class="off-btn" onclick="sendAction('${dev.id}', 'off')">Ø¥Ø·ÙØ§Ø¡</button>
                </div>
            </div>
        `).join('');
    }

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ù†ØµÙˆØµ
    function updateUI(deviceId, state) {
        const ind = document.getElementById(`ind-${deviceId}`);
        const txt = document.getElementById(`status-${deviceId}`);
        if (!ind || !txt) return;

        const isOn = state.toLowerCase() === 'on' || state === 'true';
        ind.className = isOn ? 'status-indicator on-status' : 'status-indicator off-status';
        txt.innerText = isOn ? 'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ØªØ¹Ù…Ù„' : 'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: Ù…Ø·ÙØ£Ø©';
        txt.style.color = isOn ? '#22c55e' : '#ef4444';
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    renderDevices();
    devices.forEach(d => getStatus(d.id));
</script>
</body>
</html>
